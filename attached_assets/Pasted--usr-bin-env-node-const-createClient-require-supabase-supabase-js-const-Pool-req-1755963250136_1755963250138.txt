#!/usr/bin/env node

const { createClient } = require('@supabase/supabase-js');
const { Pool } = require('pg');

// Cores para output
const colors = {
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  reset: '\x1b[0m',
  bold: '\x1b[1m'
};

function log(color, symbol, message) {
  console.log(`${color}${symbol}${colors.reset} ${message}`);
}

async function checkSupabaseConnections() {
  console.log(`${colors.bold}ðŸ” VERIFICANDO CONEXÃ•ES SUPABASE${colors.reset}\n`);

  // 1. Verificar variÃ¡veis de ambiente
  console.log(`${colors.bold}ðŸ“‹ 1. VARIÃVEIS DE AMBIENTE:${colors.reset}`);
  
  const requiredVars = [
    'SUPABASE_URL',
    'SUPABASE_ANON_KEY', 
    'SUPABASE_SERVICE_ROLE_KEY',
    'DATABASE_URL',
    'VITE_SUPABASE_URL',
    'VITE_SUPABASE_ANON_KEY'
  ];

  const envStatus = {};
  requiredVars.forEach(varName => {
    const value = process.env[varName];
    envStatus[varName] = !!value;
    
    if (value) {
      if (varName.includes('URL')) {
        log(colors.green, 'âœ…', `${varName}: ${value}`);
      } else {
        log(colors.green, 'âœ…', `${varName}: ${value.substring(0, 20)}...`);
      }
    } else {
      log(colors.red, 'âŒ', `${varName}: NÃƒO CONFIGURADA`);
    }
  });

  console.log('');

  // 2. Testar cliente Supabase
  console.log(`${colors.bold}ðŸ”— 2. TESTE DO CLIENTE SUPABASE:${colors.reset}`);
  
  const supabaseUrl = process.env.SUPABASE_URL || process.env.VITE_SUPABASE_URL;
  const supabaseKey = process.env.SUPABASE_ANON_KEY || process.env.VITE_SUPABASE_ANON_KEY;

  if (!supabaseUrl || !supabaseKey) {
    log(colors.red, 'âŒ', 'Credenciais do Supabase nÃ£o encontradas');
    return;
  }

  try {
    const supabase = createClient(supabaseUrl, supabaseKey);
    
    // Teste bÃ¡sico de conexÃ£o
    const startTime = Date.now();
    const { data, error } = await supabase.from('users').select('count').limit(1);
    const responseTime = Date.now() - startTime;

    if (error) {
      log(colors.red, 'âŒ', `Erro na conexÃ£o: ${error.message}`);
    } else {
      log(colors.green, 'âœ…', `ConexÃ£o bem-sucedida em ${responseTime}ms`);
    }
  } catch (error) {
    log(colors.red, 'âŒ', `Erro do cliente: ${error.message}`);
  }

  console.log('');

  // 3. Testar conexÃ£o com banco PostgreSQL
  console.log(`${colors.bold}ðŸ—„ï¸  3. TESTE DO BANCO POSTGRESQL:${colors.reset}`);
  
  const databaseUrl = process.env.DATABASE_URL;
  
  if (!databaseUrl) {
    log(colors.red, 'âŒ', 'DATABASE_URL nÃ£o configurada');
    return;
  }

  log(colors.blue, 'â„¹ï¸', `URL: ${databaseUrl.replace(/:[^@]*@/, ':***@')}`);

  try {
    const pool = new Pool({
      connectionString: databaseUrl,
      ssl: databaseUrl.includes('supabase.co') || databaseUrl.includes('neon.tech') ? { 
        rejectUnauthorized: false 
      } : false,
      max: 5,
      connectionTimeoutMillis: 10000,
    });

    const startTime = Date.now();
    const result = await pool.query('SELECT version(), current_database()');
    const responseTime = Date.now() - startTime;
    
    log(colors.green, 'âœ…', `ConexÃ£o PostgreSQL bem-sucedida em ${responseTime}ms`);
    log(colors.blue, 'â„¹ï¸', `VersÃ£o: ${result.rows[0].version.split(' ').slice(0, 2).join(' ')}`);
    log(colors.blue, 'â„¹ï¸', `Database: ${result.rows[0].current_database}`);

    await pool.end();
  } catch (error) {
    log(colors.red, 'âŒ', `Erro PostgreSQL: ${error.message}`);
  }

  console.log('');

  // 4. Verificar tabelas
  console.log(`${colors.bold}ðŸ“Š 4. VERIFICANDO TABELAS:${colors.reset}`);
  
  try {
    const supabase = createClient(supabaseUrl, supabaseKey);
    const tables = ['users', 'services', 'providers', 'requesters'];
    
    for (const table of tables) {
      try {
        const { count, error } = await supabase
          .from(table)
          .select('*', { count: 'exact', head: true });
          
        if (error) {
          log(colors.red, 'âŒ', `Tabela '${table}': ${error.message}`);
        } else {
          log(colors.green, 'âœ…', `Tabela '${table}': ${count || 0} registros`);
        }
      } catch (err) {
        log(colors.red, 'âŒ', `Tabela '${table}': ${err.message}`);
      }
    }
  } catch (error) {
    log(colors.red, 'âŒ', `Erro ao verificar tabelas: ${error.message}`);
  }

  console.log('');

  // 5. Resumo e recomendaÃ§Ãµes
  console.log(`${colors.bold}ðŸ“‹ 5. RESUMO:${colors.reset}`);
  
  const missingVars = requiredVars.filter(varName => !process.env[varName]);
  
  if (missingVars.length > 0) {
    log(colors.yellow, 'âš ï¸', `VariÃ¡veis faltando: ${missingVars.join(', ')}`);
    console.log('\n' + colors.yellow + 'RECOMENDAÃ‡Ã•ES:' + colors.reset);
    console.log('1. Configure as variÃ¡veis em Tools â†’ Secrets');
    console.log('2. Use os valores corretos com a senha Brandness*2025');
    console.log('3. Reinicie a aplicaÃ§Ã£o apÃ³s configurar');
  } else {
    log(colors.green, 'âœ…', 'Todas as variÃ¡veis estÃ£o configuradas');
  }

  // 6. Mostrar valores corretos para configuraÃ§Ã£o
  console.log('\n' + colors.bold + 'ðŸ”§ VALORES CORRETOS PARA SECRETS:' + colors.reset);
  console.log('\n' + colors.blue + 'DATABASE_URL:' + colors.reset);
  console.log('postgresql://postgres.wyxnyliiuxdhbbctxzlk:Brandness*2025@aws-1-sa-east-1.pooler.supabase.com:6543/postgres');
  
  console.log('\n' + colors.blue + 'SUPABASE_URL:' + colors.reset);
  console.log('https://wyxnyliiuxdhbbctxzlk.supabase.co');
  
  console.log('\n' + colors.blue + 'SUPABASE_ANON_KEY:' + colors.reset);
  console.log('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5eG55bGlpdXhkaGJiY3R4emxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1NzI0ODMsImV4cCI6MjA3MDE0ODQ4M30.-2O19Gv-u2tQMlolKYjjy3p37hfvCWjT99rsRdrBP5k');
  
  console.log('\n' + colors.blue + 'VITE_SUPABASE_URL:' + colors.reset);
  console.log('https://wyxnyliiuxdhbbctxzlk.supabase.co');
  
  console.log('\n' + colors.blue + 'VITE_SUPABASE_ANON_KEY:' + colors.reset);
  console.log('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5eG55bGlpdXhkaGJiY3R4emxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1NzI0ODMsImV4cCI6MjA3MDE0ODQ4M30.-2O19Gv-u2tQMlolKYjjy3p37hfvCWjT99rsRdrBP5k');
  
  console.log('\n' + colors.green + 'ðŸ’¡ COPIE E COLE cada valor em Tools â†’ Secrets no Replit!' + colors.reset);
}

// Executar verificaÃ§Ã£o
checkSupabaseConnections().catch(error => {
  console.error(`${colors.red}ðŸ’¥ Erro fatal:${colors.reset}`, error.message);
  process.exit(1);
});
